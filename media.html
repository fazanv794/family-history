<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Семейный архив - История моей семьи</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Шапка для приложения -->
    <header id="app-header">
        <div class="header-container container">
            <a href="app.html" class="logo" id="home-link">
                <i class="fas fa-tree"></i>
                История моей семьи
            </a>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links" id="nav-links">
                <li><a href="app.html">Главная</a></li>
                <li><a href="tree.html">Древо</a></li>
                <li><a href="timeline.html">Лента событий</a></li>
                <li><a href="media.html" class="active">Медиатека</a></li>
                <li><a href="chats.html">Чаты</a></li>
                <li><a href="profile.html">Мой профиль</a></li>
            </ul>
            
            <div class="user-menu">
                <span id="username">Гость</span>
                <div class="avatar" id="user-avatar">Г</div>
                <button class="btn btn-small" id="logout-btn">Выйти</button>
            </div>
        </div>
    </header>

    <!-- Главный контент приложения -->
    <main id="app-content">
        <!-- Страница медиатеки -->
        <section id="media-page" class="page">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Семейный архив</h2>
                    <button class="btn" id="upload-media-btn">
                        <i class="fas fa-upload"></i> Загрузить медиа
                    </button>
                </div>
                
                <div class="media-controls" style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <input type="text" id="media-search" placeholder="Поиск по описанию или имени..." style="flex: 1; min-width: 250px; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                    <select id="media-sort" style="width: auto; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        <option value="newest">Сначала новые</option>
                        <option value="oldest">Сначала старые</option>
                        <option value="name">По имени</option>
                    </select>
                    <select id="media-type-filter" style="width: auto; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;">
                        <option value="all">Все типы</option>
                        <option value="image">Фотографии</option>
                        <option value="video">Видео</option>
                        <option value="document">Документы</option>
                    </select>
                </div>
                
                <div class="media-grid" id="media-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px;">
                    <!-- Медиа будут загружены здесь -->
                </div>
            </div>
        </section>
    </main>

    <!-- Подвал -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>© 2024 История моей семьи. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Модальные окна -->
    <div class="modal-overlay hidden" id="modal-overlay"></div>
    
    <!-- Модальное окно загрузки медиа -->
    <div id="upload-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Загрузить медиа</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upload-form-modal">
                    <div class="form-group">
                        <label for="upload-url">Ссылка на медиа (URL)</label>
                        <input type="url" id="upload-url" placeholder="https://example.com/photo.jpg">
                        <small style="color: #718096;">Или выберите файлы ниже</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="upload-files">Выберите файлы</label>
                        <div class="file-upload-area" onclick="document.getElementById('upload-files').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #a0aec0; margin-bottom: 15px;"></i>
                            <p>Перетащите файлы сюда или нажмите для выбора</p>
                            <input type="file" id="upload-files" multiple accept="image/*,video/*" class="file-input" style="display: none;">
                            <button type="button" class="btn btn-small" id="browse-files-btn">
                                Выбрать файлы
                            </button>
                        </div>
                        <div id="file-list" style="display: none; margin-top: 15px;">
                            <p style="font-weight: 500; margin-bottom: 10px;">Выбранные файлы:</p>
                            <ul id="selected-files-list" style="list-style: none; padding: 0;"></ul>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="upload-description">Описание</label>
                        <input type="text" id="upload-description" placeholder="Что изображено на фото?">
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary cancel-btn">
                            Отмена
                        </button>
                        <button type="submit" class="btn">
                            <i class="fas fa-upload"></i> Загрузить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button class="notification-close">&times;</button>
        </div>
    </div>

    <!-- Загрузчик -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
        <div class="loader-text" id="loader-text">Загрузка...</div>
    </div>

    <!-- Подключаем библиотеки -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Подключаем наши файлы -->
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    
<script>
    if (!window.supabaseClient) {
        console.error('Supabase клиент не найден');
    }
    
    let currentMediaSearch = '';
    let currentMediaSort = 'newest';
    let currentMediaTypeFilter = 'all';
    
    // ЗАГРУЗКА МЕДИА ИЗ SUPABASE
    async function loadMediaFromSupabase() {
        try {
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            
            if (!user) {
                window.media = [];
                updateMediaGrid();
                return;
            }
            
            const { data, error } = await window.supabaseClient
                .from('media')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                window.media = [];
                updateMediaGrid();
                return;
            }
            
            window.media = data || [];
            applyMediaFilters();
            
        } catch (error) {
            window.media = [];
            updateMediaGrid();
        }
    }
    
    // ЗАГРУЗКА ФАЙЛА В STORAGE
    async function uploadFileToStorage(file, userId) {
        try {
            const fileExt = file.name.split('.').pop();
            const fileName = `${userId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
            
            const { data, error } = await window.supabaseClient.storage
                .from('media')
                .upload(fileName, file);
            
            if (error) throw error;
            
            // Получаем публичный URL
            const { data: { publicUrl } } = window.supabaseClient.storage
                .from('media')
                .getPublicUrl(fileName);
            
            return publicUrl;
            
        } catch (error) {
            console.error('Upload to storage error:', error);
            throw error;
        }
    }
    
    // УДАЛЕНИЕ ФАЙЛА ИЗ STORAGE
    async function deleteFileFromStorage(fileUrl) {
        try {
            // Извлекаем путь из URL
            const urlParts = fileUrl.split('/');
            const fileName = urlParts.slice(urlParts.indexOf('media') + 1).join('/');
            
            const { error } = await window.supabaseClient.storage
                .from('media')
                .remove([fileName]);
            
            if (error) throw error;
            
            return true;
            
        } catch (error) {
            console.error('Delete from storage error:', error);
            return false;
        }
    }
    
    function applyMediaFilters() {
        const container = document.getElementById('media-grid');
        if (!container) return;
        
        let filteredMedia = window.media || [];
        
        if (currentMediaSearch) {
            const searchLower = currentMediaSearch.toLowerCase();
            filteredMedia = filteredMedia.filter(item => 
                item.description && item.description.toLowerCase().includes(searchLower)
            );
        }
        
        if (currentMediaTypeFilter !== 'all') {
            filteredMedia = filteredMedia.filter(item => 
                item.file_type === currentMediaTypeFilter
            );
        }
        
        filteredMedia.sort((a, b) => {
            if (currentMediaSort === 'newest') {
                return new Date(b.created_at) - new Date(a.created_at);
            } else if (currentMediaSort === 'oldest') {
                return new Date(a.created_at) - new Date(b.created_at);
            } else if (currentMediaSort === 'name') {
                return (a.description || '').localeCompare(b.description || '');
            }
            return 0;
        });
        
        displayMediaItems(filteredMedia);
    }
    
    function displayMediaItems(mediaItems) {
        const container = document.getElementById('media-grid');
        if (!container) return;
        
        if (mediaItems.length === 0) {
            container.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #718096; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                    <i class="fas fa-images" style="font-size: 4rem; margin-bottom: 20px; color: #cbd5e0;"></i>
                    <h3 style="margin-bottom: 10px; color: #4a5568;">Медиафайлов пока нет</h3>
                    <p style="margin-bottom: 25px;">Загрузите первое фото или видео в ваш семейный архив</p>
                    <button class="btn" onclick="window.openUploadModal()">
                        <i class="fas fa-upload"></i> Загрузить медиа
                    </button>
                </div>
            `;
            return;
        }
        
        let html = '';
        mediaItems.forEach(item => {
            const isImage = item.file_type === 'image';
            const isVideo = item.file_type === 'video';
            const createdDate = new Date(item.created_at).toLocaleDateString('ru-RU');
            
            let mediaPreview = '';
            if (isImage) {
                mediaPreview = `
                    <img src="${item.file_url}" 
                         alt="${item.description || 'Фото'}" 
                         style="width: 100%; height: 180px; object-fit: cover; border-radius: 8px 8px 0 0;"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/300/667eea/ffffff?text=Фото';">
                `;
            } else if (isVideo) {
                mediaPreview = `
                    <div style="width: 100%; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                        <i class="fas fa-play-circle"></i>
                    </div>
                `;
            } else {
                mediaPreview = `
                    <div style="width: 100%; height: 180px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); border-radius: 8px 8px 0 0; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem;">
                        <i class="fas fa-file"></i>
                    </div>
                `;
            }
            
            html += `
                <div class="media-item" style="border-radius: 8px; overflow: hidden; box-shadow: 0 3px 15px rgba(0,0,0,0.08); background: white; transition: all 0.3s; border: 1px solid #e2e8f0;">
                    ${mediaPreview}
                    <div class="media-description" style="padding: 20px;">
                        <div style="margin-bottom: 10px; font-weight: 500; color: #2d3748; height: 50px; overflow: hidden; text-overflow: ellipsis;">
                            ${escapeHtml(item.description || 'Без описания')}
                        </div>
                        <div style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                            <span>${createdDate}</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-small" onclick="window.viewMedia('${item.id}')" style="flex: 1;">
                                <i class="fas fa-eye"></i> Просмотр
                            </button>
                            <button class="btn btn-small btn-danger" onclick="window.deleteMedia('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function updateMediaGrid() {
        applyMediaFilters();
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
    
    function getMediaTypeFromUrl(url) {
        if (!url) return 'link';
        const lowerUrl = url.toLowerCase();
        if (lowerUrl.match(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/)) return 'image';
        if (lowerUrl.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv)$/)) return 'video';
        if (lowerUrl.match(/\.(mp3|wav|ogg|flac|aac)$/)) return 'audio';
        if (lowerUrl.match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt)$/)) return 'document';
        return 'link';
    }
    
    async function saveMediaToSupabase(mediaData) {
        try {
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            
            if (!user) {
                window.showNotification('Необходимо авторизоваться', 'error');
                return null;
            }
            
            // Только поля, которые есть в таблице
            const mediaForDb = {
                file_url: mediaData.file_url,
                file_type: mediaData.file_type,
                description: mediaData.description || '',
                user_id: user.id
            };
            
            const { data, error } = await window.supabaseClient
                .from('media')
                .insert(mediaForDb)
                .select();
            
            if (error) {
                console.error('Supabase error:', error);
                window.showNotification('Ошибка: ' + error.message, 'error');
                return null;
            }
            
            return data?.[0] || null;
            
        } catch (error) {
            console.error('Save error:', error);
            window.showNotification('Ошибка сохранения', 'error');
            return null;
        }
    }
    
    async function deleteMediaFromSupabase(mediaId, fileUrl) {
        try {
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            
            if (!user) {
                window.showNotification('Необходимо авторизоваться', 'error');
                return false;
            }
            
            // Удаляем из базы данных
            const { error: dbError } = await window.supabaseClient
                .from('media')
                .delete()
                .eq('id', mediaId);
            
            if (dbError) throw dbError;
            
            // Если это файл из Storage, удаляем его
            if (fileUrl && fileUrl.includes('supabase.co/storage')) {
                await deleteFileFromStorage(fileUrl);
            }
            
            return true;
            
        } catch (error) {
            console.error('Delete error:', error);
            return false;
        }
    }
    
    window.openUploadModal = function() {
        const modalHtml = `
            <div class="modal" id="upload-media-modal" style="max-width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Загрузить медиа</h3>
                        <button class="modal-close" onclick="window.closeUploadModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="upload-media-form" onsubmit="return false;">
                            <div class="form-group">
                                <label>Ссылка на медиа (URL)</label>
                                <input type="url" id="upload-media-url" class="form-control" placeholder="https://example.com/photo.jpg">
                                <small style="color: #718096;">Или загрузите файл ниже</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Выберите файл</label>
                                <input type="file" id="upload-media-file" class="form-control" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
                            </div>
                            
                            <div class="form-group">
                                <label>Описание</label>
                                <input type="text" id="upload-media-description" class="form-control" placeholder="Что изображено на фото?">
                            </div>
                            
                            <div class="modal-footer" style="padding: 20px 0 0 0;">
                                <button type="button" class="btn btn-secondary" onclick="window.closeUploadModal()">
                                    Отмена
                                </button>
                                <button type="button" class="btn" onclick="window.saveNewMedia()">
                                    <i class="fas fa-upload"></i> Загрузить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        const overlay = document.getElementById('modal-overlay');
        overlay.innerHTML = modalHtml;
        overlay.classList.remove('hidden');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    };
    
    window.closeUploadModal = function() {
        const overlay = document.getElementById('modal-overlay');
        overlay.classList.remove('active');
        setTimeout(() => {
            overlay.classList.add('hidden');
            overlay.innerHTML = '';
        }, 300);
        document.body.style.overflow = '';
    };
    
    window.saveNewMedia = async function() {
        const url = document.getElementById('upload-media-url').value;
        const file = document.getElementById('upload-media-file').files[0];
        const description = document.getElementById('upload-media-description').value;
        
        if (!url && !file) {
            window.showNotification('Введите URL или выберите файл', 'error');
            return;
        }
        
        window.showLoader('Загрузка...');
        
        try {
            const { data: { user } } = await window.supabaseClient.auth.getUser();
            
            if (!user) {
                window.showNotification('Необходимо авторизоваться', 'error');
                return;
            }
            
            let fileUrl;
            let fileType;
            
            if (file) {
                // Загружаем файл в Storage
                fileUrl = await uploadFileToStorage(file, user.id);
                
                // Определяем тип файла
                if (file.type.startsWith('image/')) fileType = 'image';
                else if (file.type.startsWith('video/')) fileType = 'video';
                else if (file.type.startsWith('audio/')) fileType = 'audio';
                else fileType = 'document';
            } else {
                // Используем URL
                fileUrl = url;
                fileType = getMediaTypeFromUrl(url);
            }
            
            const mediaData = {
                file_url: fileUrl,
                file_type: fileType,
                description: description || (file ? file.name : 'Ссылка на медиа')
            };
            
            const savedMedia = await saveMediaToSupabase(mediaData);
            
            if (savedMedia) {
                if (!window.media) window.media = [];
                window.media.unshift(savedMedia);
                
                window.showNotification('✅ Медиа загружено!', 'success');
                window.closeUploadModal();
                applyMediaFilters();
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            window.showNotification('Ошибка загрузки: ' + error.message, 'error');
        } finally {
            window.hideLoader();
        }
    };
    
    window.viewMedia = function(mediaId) {
        const item = window.media.find(m => m.id == mediaId);
        if (!item) return;
        
        const isImage = item.file_type === 'image';
        const isVideo = item.file_type === 'video';
        
        let mediaContent = '';
        if (isImage) {
            mediaContent = `<img src="${item.file_url}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px;">`;
        } else if (isVideo) {
            mediaContent = `
                <video controls style="width: 100%; max-height: 400px; border-radius: 8px;">
                    <source src="${item.file_url}" type="video/mp4">
                </video>
            `;
        } else {
            mediaContent = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-file" style="font-size: 4rem; color: #667eea;"></i>
                </div>
            `;
        }
        
        const modalHtml = `
            <div class="modal" id="view-media-modal" style="max-width: 700px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Просмотр медиа</h3>
                        <button class="modal-close" onclick="window.closeViewModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${mediaContent}
                        <h4 style="margin: 20px 0 10px;">${escapeHtml(item.description || 'Без описания')}</h4>
                        <p style="color: #718096;">Загружено: ${new Date(item.created_at).toLocaleDateString('ru-RU')}</p>
                        <a href="${item.file_url}" target="_blank" class="btn" style="margin-top: 20px; display: block; text-align: center;">
                            <i class="fas fa-external-link-alt"></i> Открыть
                        </a>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="window.closeViewModal()">Закрыть</button>
                    </div>
                </div>
            </div>
        `;
        
        const overlay = document.getElementById('modal-overlay');
        overlay.innerHTML = modalHtml;
        overlay.classList.remove('hidden');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    };
    
    window.closeViewModal = function() {
        const overlay = document.getElementById('modal-overlay');
        overlay.classList.remove('active');
        setTimeout(() => {
            overlay.classList.add('hidden');
            overlay.innerHTML = '';
        }, 300);
        document.body.style.overflow = '';
    };
    
    window.deleteMedia = async function(mediaId) {
        if (!confirm('Удалить этот медиафайл?')) return;
        
        window.showLoader('Удаление...');
        
        try {
            const item = window.media.find(m => m.id == mediaId);
            if (!item) return;
            
            const deleted = await deleteMediaFromSupabase(mediaId, item.file_url);
            
            if (deleted) {
                window.media = window.media.filter(m => m.id != mediaId);
                window.showNotification('✅ Медиафайл удален!', 'success');
                applyMediaFilters();
            }
            
        } catch (error) {
            window.showNotification('Ошибка удаления', 'error');
        } finally {
            window.hideLoader();
        }
    };
    
    document.addEventListener('DOMContentLoaded', async () => {
        await loadMediaFromSupabase();
        
        const uploadBtn = document.getElementById('upload-media-btn');
        if (uploadBtn) {
            uploadBtn.onclick = function(e) {
                e.preventDefault();
                window.openUploadModal();
                return false;
            };
        }
        
        const searchInput = document.getElementById('media-search');
        const sortSelect = document.getElementById('media-sort');
        const typeFilter = document.getElementById('media-type-filter');
        
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                currentMediaSearch = e.target.value;
                applyMediaFilters();
            });
        }
        
        if (sortSelect) {
            sortSelect.addEventListener('change', function(e) {
                currentMediaSort = e.target.value;
                applyMediaFilters();
            });
        }
        
        if (typeFilter) {
            typeFilter.addEventListener('change', function(e) {
                currentMediaTypeFilter = e.target.value;
                applyMediaFilters();
            });
        }
    });
</script>
</body>
</html>