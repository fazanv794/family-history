<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ - –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- –®–∞–ø–∫–∞ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <header id="app-header">
        <div class="header-container container">
            <a href="app.html" class="logo" id="home-link">
                <i class="fas fa-tree"></i>
                –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏
            </a>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links" id="nav-links">
                <li><a href="app.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="tree.html" class="active">–î—Ä–µ–≤–æ</a></li>
                <li><a href="timeline.html">–õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</a></li>
                <li><a href="media.html">–ú–µ–¥–∏–∞—Ç–µ–∫–∞</a></li>
                <li><a href="profile.html">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a></li>
            </ul>
            
            <div class="user-menu">
                <span id="username">–ì–æ—Å—Ç—å</span>
                <div class="avatar" id="user-avatar">–ì</div>
                <button class="btn btn-small" id="logout-btn">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </header>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <main id="app-content">
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥—Ä–µ–≤–∞ -->
        <section id="tree-page" class="page">
            <div class="container">
                <h2>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</h2>
                
                <div class="tree-controls">
                    <button class="btn" id="auto-build-btn">
                        <i class="fas fa-magic"></i> –ê–≤—Ç–æ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-secondary" id="manual-add-btn">
                        <i class="fas fa-hand-pointer"></i> –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-secondary" id="save-image-btn">
                        <i class="fas fa-image"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É
                    </button>
                    <button class="btn btn-secondary" id="print-tree-btn">
                        <i class="fas fa-print"></i> –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å
                    </button>
                </div>
                
                <div class="tree-auto-options" style="display: none;">
                    <!-- –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–ø—Ü–∏–∏ -->
                </div>
                
                <div class="tree-visualization-container" id="tree-visualization-container">
                    <div class="tree-empty-state">
                        <i class="fas fa-tree" style="font-size: 4rem; color: #cbd5e0; margin-bottom: 20px;"></i>
                        <h3>–î–µ—Ä–µ–≤–æ –µ—â–µ –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ</h3>
                        <p>–ù–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≤–∞—à–µ –ø–µ—Ä–≤–æ–µ –≥–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</p>
                        <button class="btn" id="auto-build-btn-2" style="margin-top: 20px;">
                            <i class="fas fa-magic"></i> –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ
                        </button>
                    </div>
                </div>
                
                <div class="tree-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="tree-people-count">0</h3>
                        <p>–õ—é–¥–µ–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-images"></i>
                        <h3 id="tree-photos-count">0</h3>
                        <p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group"></i>
                        <h3 id="tree-generations">0</h3>
                        <p>–ü–æ–∫–æ–ª–µ–Ω–∏–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-link"></i>
                        <h3 id="tree-connections">0</h3>
                        <p>–°–≤—è–∑–µ–π</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>¬© 2024 –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay hidden" id="modal-overlay"></div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button class="notification-close">&times;</button>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ —Ñ–∞–π–ª—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -->
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    <script src="tree-builder.js"></script>
    <script src="tree-engine.js"></script>
    
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üå≥ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ä–µ–≤–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            const checkAuth = () => {
                if (!window.currentUser) {
                    console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    window.showNotification('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                    setTimeout(() => {
                        window.location.href = 'auth.html';
                    }, 1500);
                    return false;
                }
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', window.currentUser.email);
                return true;
            };
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            setTimeout(() => {
                if (!checkAuth()) return;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤–∞ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                if (!window.treeData) {
                    window.treeData = {
                        people: [],
                        currentPerson: null,
                        treeStructure: null
                    };
                }
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
                document.getElementById('auto-build-btn')?.addEventListener('click', () => {
                    console.log('üéØ –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ-–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞');
                    if (!window.currentUser) {
                        window.showNotification('–î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 1500);
                        return;
                    }
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—à–∞–≥–æ–≤–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
                    if (window.startTreeBuilder) {
                        window.startTreeBuilder();
                    } else {
                        console.error('‚ùå startTreeBuilder –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    }
                });
                
                document.getElementById('auto-build-btn-2')?.addEventListener('click', () => {
                    console.log('üéØ –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ-–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è 2 –Ω–∞–∂–∞—Ç–∞');
                    if (!window.currentUser) {
                        window.showNotification('–î–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 1500);
                        return;
                    }
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—à–∞–≥–æ–≤–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
                    if (window.startTreeBuilder) {
                        window.startTreeBuilder();
                    } else {
                        console.error('‚ùå startTreeBuilder –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    }
                });
                
                document.getElementById('manual-add-btn')?.addEventListener('click', () => {
                    console.log('üéØ –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∂–∞—Ç–∞');
                    if (!window.currentUser) {
                        window.showNotification('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 1500);
                        return;
                    }
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞
                    if (window.addNewPerson) {
                        window.addNewPerson('other');
                    } else {
                        console.error('‚ùå addNewPerson –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    }
                });
                
                document.getElementById('save-image-btn')?.addEventListener('click', () => {
                    if (!window.currentUser) {
                        window.showNotification('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 1500);
                        return;
                    }
                    if (window.saveTreeAsImage) window.saveTreeAsImage();
                });
                
                document.getElementById('print-tree-btn')?.addEventListener('click', () => {
                    if (!window.currentUser) {
                        window.showNotification('–î–ª—è –ø–µ—á–∞—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                        setTimeout(() => {
                            window.location.href = 'auth.html';
                        }, 1500);
                        return;
                    }
                    if (window.printTree) window.printTree();
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                if (window.updateTreePreview && window.treeData && window.treeData.people.length > 0) {
                    window.updateTreePreview();
                }
                
                console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ä–µ–≤–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:', {
                    startTreeBuilder: typeof window.startTreeBuilder,
                    addNewPerson: typeof window.addNewPerson,
                    updateTreePreview: typeof window.updateTreePreview,
                    buildFinalTree: typeof window.buildFinalTree
                });
            }, 300);
        });
    </script>
</body>
</html>