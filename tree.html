<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ - –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- –®–∞–ø–∫–∞ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <header id="app-header">
        <div class="header-container container">
            <a href="app.html" class="logo" id="home-link">
                <i class="fas fa-tree"></i>
                –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏
            </a>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links" id="nav-links">
                <li><a href="app.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="tree.html" class="active">–î—Ä–µ–≤–æ</a></li>
                <li><a href="timeline.html">–õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π</a></li>
                <li><a href="media.html">–ú–µ–¥–∏–∞—Ç–µ–∫–∞</a></li>
                <li><a href="profile.html">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</a></li>
            </ul>
            
            <div class="user-menu">
                <span id="username">–ì–æ—Å—Ç—å</span>
                <div class="avatar" id="user-avatar">–ì</div>
                <button class="btn btn-small" id="logout-btn">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </header>

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <main id="app-content">
        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥—Ä–µ–≤–∞ -->
        <section id="tree-page" class="page">
            <div class="container">
                <h2>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</h2>
                
                <div class="tree-controls">
                    <button class="btn" id="auto-build-btn">
                        <i class="fas fa-magic"></i> –ê–≤—Ç–æ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-secondary" id="manual-add-btn">
                        <i class="fas fa-hand-pointer"></i> –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                    </button>
                    <button class="btn btn-secondary" id="save-image-btn">
                        <i class="fas fa-image"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É
                    </button>
                    <button class="btn btn-secondary" id="print-tree-btn">
                        <i class="fas fa-print"></i> –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å
                    </button>
                </div>
                
                <div class="tree-auto-options">
                    <div class="form-group">
                        <label for="auto-generations">–ü–æ–∫–æ–ª–µ–Ω–∏—è</label>
                        <select id="auto-generations">
                            <option value="2">2 –ø–æ–∫–æ–ª–µ–Ω–∏—è</option>
                            <option value="3" selected>3 –ø–æ–∫–æ–ª–µ–Ω–∏—è</option>
                            <option value="4">4 –ø–æ–∫–æ–ª–µ–Ω–∏—è</option>
                            <option value="5">5 –ø–æ–∫–æ–ª–µ–Ω–∏–π</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-style">–°—Ç–∏–ª—å</label>
                        <select id="auto-style">
                            <option value="horizontal" selected>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π</option>
                            <option value="vertical">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π</option>
                            <option value="radial">–†–∞–¥–∏–∞–ª—å–Ω—ã–π</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="auto-center-person">–¶–µ–Ω—Ç—Ä –¥—Ä–µ–≤–∞</label>
                        <select id="auto-center-person">
                            <option value="self" selected>–Ø</option>
                            <option value="oldest">–°–∞–º—ã–π —Å—Ç–∞—Ä—à–∏–π</option>
                            <option value="founder">–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å —Ä–æ–¥–∞</option>
                        </select>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto-show-photos" checked>
                        <label for="auto-show-photos">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–æ—Ç–æ</label>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto-show-dates" checked>
                        <label for="auto-show-dates">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∞—Ç—ã</label>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto-show-lines" checked>
                        <label for="auto-show-lines">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏–Ω–∏–∏ —Å–≤—è–∑–∏</label>
                    </div>
                </div>
                
                <div class="tree-visualization-container" id="tree-visualization-container">
                    <div class="tree-empty-state">
                        <i class="fas fa-tree" style="font-size: 4rem; color: #cbd5e0; margin-bottom: 20px;"></i>
                        <h3>–î–µ—Ä–µ–≤–æ –µ—â–µ –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ</h3>
                        <p>–ù–∞–∂–º–∏—Ç–µ "–ê–≤—Ç–æ–ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –≤–∞—à–µ –ø–µ—Ä–≤–æ–µ –≥–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</p>
                        <button class="btn" id="auto-build-btn-2" style="margin-top: 20px;">
                            <i class="fas fa-magic"></i> –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ
                        </button>
                    </div>
                </div>
                
                <div class="tree-stats">
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3 id="tree-people-count">0</h3>
                        <p>–õ—é–¥–µ–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-images"></i>
                        <h3 id="tree-photos-count">0</h3>
                        <p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-layer-group"></i>
                        <h3 id="tree-generations">0</h3>
                        <p>–ü–æ–∫–æ–ª–µ–Ω–∏–π</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-link"></i>
                        <h3 id="tree-connections">0</h3>
                        <p>–°–≤—è–∑–µ–π</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>¬© 2024 –ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal-overlay hidden" id="modal-overlay"></div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞ -->
    <div id="add-person-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–æ–±–∞–≤–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –≤ –¥—Ä–µ–≤–æ</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-person-form-modal">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="person-first-name">–ò–º—è *</label>
                            <input type="text" id="person-first-name" placeholder="–ò–º—è" required>
                        </div>
                        <div class="form-group">
                            <label for="person-last-name">–§–∞–º–∏–ª–∏—è *</label>
                            <input type="text" id="person-last-name" placeholder="–§–∞–º–∏–ª–∏—è" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="person-birth-date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                            <input type="date" id="person-birth-date">
                        </div>
                        <div class="form-group">
                            <label for="person-death-date">–î–∞—Ç–∞ —Å–º–µ—Ä—Ç–∏</label>
                            <input type="date" id="person-death-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="person-gender">–ü–æ–ª</label>
                        <select id="person-gender" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª</option>
                            <option value="male">–ú—É–∂—Å–∫–æ–π</option>
                            <option value="female">–ñ–µ–Ω—Å–∫–∏–π</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="person-relation">–†–æ–¥—Å—Ç–≤–æ *</label>
                        <select id="person-relation" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–¥—Å—Ç–≤–æ</option>
                            <option value="self">–Ø</option>
                            <option value="spouse">–°—É–ø—Ä—É–≥/–∞</option>
                            <option value="parent">–†–æ–¥–∏—Ç–µ–ª—å</option>
                            <option value="child">–†–µ–±–µ–Ω–æ–∫</option>
                            <option value="sibling">–ë—Ä–∞—Ç/—Å–µ—Å—Ç—Ä–∞</option>
                            <option value="grandparent">–î–µ–¥—É—à–∫–∞/–±–∞–±—É—à–∫–∞</option>
                            <option value="grandchild">–í–Ω—É–∫/–≤–Ω—É—á–∫–∞</option>
                            <option value="aunt_uncle">–¢–µ—Ç—è/–¥—è–¥—è</option>
                            <option value="cousin">–î–≤–æ—é—Ä–æ–¥–Ω—ã–π –±—Ä–∞—Ç/—Å–µ—Å—Ç—Ä–∞</option>
                            <option value="other">–î—Ä—É–≥–æ–π —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="person-photo-url">–§–æ—Ç–æ (URL)</label>
                        <input type="url" id="person-photo-url" placeholder="https://example.com/photo.jpg">
                        <small style="color: #718096;">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="person-bio">–ë–∏–æ–≥—Ä–∞—Ñ–∏—è</label>
                        <textarea id="person-bio" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary cancel-btn">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn">
                            –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä–µ–≤–æ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button class="notification-close">&times;</button>
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
        <div class="loader-text" id="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ —Ñ–∞–π–ª—ã -->
    <script src="supabase.js"></script>
    <script src="tree-engine.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ä–µ–≤–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                    window.location.href = 'auth.html';
                    return;
                }
                
                if (!user) {
                    window.location.href = 'auth.html';
                    return;
                }
                
                console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', user.email);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const displayName = user.user_metadata?.name || user.user_metadata?.full_name || user.email?.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('username').textContent = displayName;
                document.getElementById('user-avatar').textContent = getUserInitials(displayName);
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
                window.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error');
            }
        });
        
        function getUserInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        function setupEventListeners() {
            // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('mobile-menu-btn')?.addEventListener('click', () => {
                document.getElementById('nav-links').classList.toggle('active');
            });
            
            // –í—ã—Ö–æ–¥
            document.getElementById('logout-btn')?.addEventListener('click', async () => {
                try {
                    const { error } = await window.supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    window.showNotification('‚úÖ –í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                    window.showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'error');
                }
            });
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ—Ä–µ–≤–∞
            document.getElementById('auto-build-btn')?.addEventListener('click', () => {
                autoBuildTree();
            });
            
            document.getElementById('auto-build-btn-2')?.addEventListener('click', () => {
                autoBuildTree();
            });
            
            document.getElementById('manual-add-btn')?.addEventListener('click', () => {
                document.getElementById('add-person-modal').classList.remove('hidden');
                document.getElementById('modal-overlay').classList.remove('hidden');
            });
            
            document.getElementById('save-image-btn')?.addEventListener('click', () => {
                saveTreeAsImage();
            });
            
            document.getElementById('print-tree-btn')?.addEventListener('click', () => {
                printTree();
            });
            
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ - –∑–∞–∫—Ä—ã—Ç–∏–µ
            document.querySelectorAll('.modal-close, .cancel-btn').forEach(btn => {
                btn.addEventListener('click', closeAllModals);
            });
            
            document.getElementById('modal-overlay')?.addEventListener('click', closeAllModals);
            
            // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞
            document.getElementById('add-person-form-modal')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const firstName = document.getElementById('person-first-name').value;
                const lastName = document.getElementById('person-last-name').value;
                const birthDate = document.getElementById('person-birth-date').value;
                const deathDate = document.getElementById('person-death-date').value;
                const gender = document.getElementById('person-gender').value;
                const relation = document.getElementById('person-relation').value;
                const photoUrl = document.getElementById('person-photo-url').value;
                const biography = document.getElementById('person-bio').value;
                
                if (!firstName || !lastName || !gender || !relation) {
                    window.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                window.showLoader('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —á–µ–ª–æ–≤–µ–∫–∞...');
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    
                    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
                    // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    
                    setTimeout(() => {
                        window.showNotification('‚úÖ –ß–µ–ª–æ–≤–µ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
                        closeAllModals();
                        document.getElementById('add-person-form-modal').reset();
                        
                        // –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ä–µ–≤–æ
                        autoBuildTree();
                        
                    }, 1500);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞:', error);
                    window.showNotification('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —á–µ–ª–æ–≤–µ–∫–∞', 'error');
                } finally {
                    window.hideLoader();
                }
            });
        }
        
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
            document.getElementById('modal-overlay').classList.add('hidden');
        }
        
        function autoBuildTree() {
            window.showLoader('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –¥—Ä–µ–≤–∞...');
            
            setTimeout(() => {
                const container = document.getElementById('tree-visualization-container');
                if (!container) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const generations = parseInt(document.getElementById('auto-generations')?.value || 3);
                const style = document.getElementById('auto-style')?.value || 'horizontal';
                const centerPerson = document.getElementById('auto-center-person')?.value || 'self';
                
                // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ—Ä–µ–≤–∞
                const treeData = {
                    name: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω",
                    birth: "1990",
                    children: [
                        {
                            name: "–ò–≤–∞–Ω–æ–≤ –ê–ª–µ–∫—Å–µ–π",
                            birth: "2015",
                            relation: "—Å—ã–Ω"
                        },
                        {
                            name: "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞", 
                            birth: "2018",
                            relation: "–¥–æ—á—å"
                        }
                    ],
                    parents: [
                        {
                            name: "–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä",
                            birth: "1960",
                            death: "2020",
                            relation: "–æ—Ç–µ—Ü"
                        },
                        {
                            name: "–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è",
                            birth: "1965",
                            relation: "–º–∞—Ç—å" 
                        }
                    ],
                    grandparents: [
                        {
                            name: "–ò–≤–∞–Ω–æ–≤ –°–µ—Ä–≥–µ–π",
                            birth: "1930",
                            death: "2000",
                            relation: "–¥–µ–¥"
                        },
                        {
                            name: "–ò–≤–∞–Ω–æ–≤–∞ –û–ª—å–≥–∞",
                            birth: "1935",
                            death: "2005",
                            relation: "–±–∞–±—É—à–∫–∞"
                        }
                    ]
                };
                
                let html = `
                    <div class="tree-container" style="padding: 20px; text-align: center;">
                        <h3 style="color: #2d3748; margin-bottom: 30px;">–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ —Å–µ–º—å–∏</h3>
                        
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 40px;">
                `;
                
                // –ü–æ–∫–æ–ª–µ–Ω–∏–µ 3: –ë–∞–±—É—à–∫–∏/–¥–µ–¥—É—à–∫–∏
                if (generations >= 3 && treeData.grandparents.length > 0) {
                    html += `
                        <div style="display: flex; gap: 100px; margin-bottom: 20px;">
                            ${treeData.grandparents.map(gp => `
                                <div class="tree-person" style="text-align: center;">
                                    <div style="width: 70px; height: 70px; background: #a0aec0; color: white; border-radius: 50%; 
                                              display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem;">
                                        ${gp.name.split(' ')[0][0]}${gp.name.split(' ')[1][0]}
                                    </div>
                                    <div style="font-weight: bold; font-size: 0.9rem;">${gp.name}</div>
                                    <div style="font-size: 0.8rem; color: #718096;">${gp.birth}${gp.death ? `-${gp.death}` : ''}</div>
                                    <div style="font-size: 0.8rem; color: #667eea;">${gp.relation}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="height: 20px; display: flex; justify-content: center;">
                            <div style="width: 2px; height: 100%; background: #cbd5e0;"></div>
                        </div>
                    `;
                }
                
                // –ü–æ–∫–æ–ª–µ–Ω–∏–µ 2: –†–æ–¥–∏—Ç–µ–ª–∏
                if (generations >= 2 && treeData.parents.length > 0) {
                    html += `
                        <div style="display: flex; gap: 150px; margin-bottom: 20px;">
                            ${treeData.parents.map(parent => `
                                <div class="tree-person" style="text-align: center;">
                                    <div style="width: 80px; height: 80px; background: #667eea; color: white; border-radius: 50%; 
                                              display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.8rem;">
                                        ${parent.name.split(' ')[0][0]}${parent.name.split(' ')[1][0]}
                                    </div>
                                    <div style="font-weight: bold;">${parent.name}</div>
                                    <div style="font-size: 0.9rem; color: #718096;">${parent.birth}${parent.death ? `-${parent.death}` : ''}</div>
                                    <div style="font-size: 0.9rem; color: #48bb78;">${parent.relation}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="height: 20px; display: flex; justify-content: center;">
                            <div style="width: 2px; height: 100%; background: #cbd5e0;"></div>
                        </div>
                    `;
                }
                
                // –ü–æ–∫–æ–ª–µ–Ω–∏–µ 1: –Ø (—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)
                html += `
                    <div class="tree-person" style="text-align: center;">
                        <div style="width: 100px; height: 100px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); 
                                  color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                  margin: 0 auto 15px; font-size: 2.2rem; border: 4px solid white; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                            –Ø
                        </div>
                        <div style="font-weight: bold; font-size: 1.2rem;">${treeData.name}</div>
                        <div style="font-size: 1rem; color: #718096;">—Ä–æ–¥. ${treeData.birth}</div>
                        <div style="font-size: 1rem; color: #ed64a6; font-weight: bold;">–Ø</div>
                    </div>
                    
                    <div style="height: 20px; display: flex; justify-content: center;">
                        <div style="width: 2px; height: 100%; background: #cbd5e0;"></div>
                    </div>
                `;
                
                // –ü–æ–∫–æ–ª–µ–Ω–∏–µ 0: –î–µ—Ç–∏
                if (generations >= 1 && treeData.children.length > 0) {
                    html += `
                        <div style="display: flex; gap: 150px; margin-top: 20px;">
                            ${treeData.children.map(child => `
                                <div class="tree-person" style="text-align: center;">
                                    <div style="width: 80px; height: 80px; background: ${child.relation === '—Å—ã–Ω' ? '#4299e1' : '#ed64a6'}; 
                                              color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                              margin: 0 auto 10px; font-size: 1.8rem;">
                                        ${child.name.split(' ')[0][0]}${child.name.split(' ')[1][0]}
                                    </div>
                                    <div style="font-weight: bold;">${child.name}</div>
                                    <div style="font-size: 0.9rem; color: #718096;">—Ä–æ–¥. ${child.birth}</div>
                                    <div style="font-size: 0.9rem; color: #d69e2e;">${child.relation}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                html += `
                        </div>
                        
                        <div style="margin-top: 40px; padding: 20px; background: #f7fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h4 style="color: #4a5568; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ—Ä–µ–≤–µ:</h4>
                            <p style="color: #718096; margin-bottom: 5px;">‚Ä¢ –°—Ç–∏–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: <strong>${style === 'horizontal' ? '–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π' : style === 'vertical' ? '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π' : '–†–∞–¥–∏–∞–ª—å–Ω—ã–π'}</strong></p>
                            <p style="color: #718096; margin-bottom: 5px;">‚Ä¢ –ü–æ–∫–æ–ª–µ–Ω–∏–π: <strong>${generations}</strong></p>
                            <p style="color: #718096;">‚Ä¢ –í—Å–µ–≥–æ –ª—é–¥–µ–π: <strong>${1 + (treeData.parents?.length || 0) + (treeData.children?.length || 0) + (treeData.grandparents?.length || 0)}</strong></p>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateTreeStats();
                
                window.showNotification('‚úÖ –ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ!', 'success');
                window.hideLoader();
            }, 2000);
        }
        
        function updateTreeStats() {
            const peopleCount = 7; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            document.getElementById('tree-people-count').textContent = peopleCount;
            document.getElementById('tree-photos-count').textContent = '0';
            document.getElementById('tree-generations').textContent = document.getElementById('auto-generations')?.value || 3;
            document.getElementById('tree-connections').textContent = peopleCount - 1;
        }
        
        function saveTreeAsImage() {
            const container = document.getElementById('tree-visualization-container');
            if (!container || container.innerHTML.includes('tree-empty-state')) {
                window.showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –¥–µ—Ä–µ–≤–æ', 'error');
                return;
            }
            
            window.showLoader('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
            
            // –ò–º–∏—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            setTimeout(() => {
                window.showNotification('‚úÖ –î–µ—Ä–µ–≤–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!', 'success');
                window.hideLoader();
            }, 1500);
        }
        
        function printTree() {
            const container = document.getElementById('tree-visualization-container');
            if (!container || container.innerHTML.includes('tree-empty-state')) {
                window.showNotification('–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç—Ä–æ–π—Ç–µ –¥–µ—Ä–µ–≤–æ', 'error');
                return;
            }
            
            window.showNotification('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ø–µ—á–∞—Ç–∏...', 'info');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .tree-print { max-width: 800px; margin: 0 auto; }
                        .tree-person { text-align: center; margin: 10px; }
                        @media print {
                            body { padding: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div class="tree-print">
                        <h1 style="text-align: center; color: #2d3748; margin-bottom: 30px;">–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥—Ä–µ–≤–æ</h1>
                        ${container.innerHTML}
                        <div style="text-align: center; margin-top: 40px; color: #718096; font-size: 0.9rem;">
                            –°–æ–∑–¥–∞–Ω–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ "–ò—Å—Ç–æ—Ä–∏—è –º–æ–µ–π —Å–µ–º—å–∏"<br>
                            –î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}
                        </div>
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(() => window.close(), 1000);
                        }
                    </script>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(printContent);
                printWindow.document.close();
            }
        }
    </script>
</body>
</html>