<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лента событий - История моей семьи</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Шапка для приложения -->
    <header id="app-header">
        <div class="header-container container">
            <a href="app.html" class="logo" id="home-link">
                <i class="fas fa-tree"></i>
                История моей семьи
            </a>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links" id="nav-links">
                <li><a href="app.html">Главная</a></li>
                <li><a href="tree.html">Древо</a></li>
                <li><a href="timeline.html" class="active">Лента событий</a></li>
                <li><a href="media.html">Медиатека</a></li>
                <li><a href="profile.html">Мой профиль</a></li>
            </ul>
            
            <div class="user-menu">
                <span id="username">Гость</span>
                <div class="avatar" id="user-avatar">Г</div>
                <button class="btn btn-small" id="logout-btn">Выйти</button>
            </div>
        </div>
    </header>

    <!-- Главный контент приложения -->
    <main id="app-content">
        <!-- Страница ленты событий -->
        <section id="timeline-page" class="page">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Лента семейных событий</h2>
                    <button class="btn" id="add-event-btn">
                        <i class="fas fa-plus"></i> Добавить событие
                    </button>
                </div>
                
                <div id="timeline-filters" style="margin-bottom: 30px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <select id="filter-year" class="form-group" style="width: auto;">
                            <option value="">Все годы</option>
                        </select>
                        <select id="filter-type" class="form-group" style="width: auto;">
                            <option value="">Все типы</option>
                            <option value="birthday">День рождения</option>
                            <option value="wedding">Свадьба</option>
                            <option value="anniversary">Годовщина</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                </div>
                
                <div class="timeline-container" id="timeline-container">
                    <!-- События будут загружены здесь -->
                </div>
            </div>
        </section>
    </main>

    <!-- Подвал -->
    <footer>
        <div class="container">
            <div class="copyright">
                <p>© 2024 История моей семьи. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Модальные окна -->
    <div class="modal-overlay hidden" id="modal-overlay"></div>
    
    <!-- Модальное окно добавления события -->
    <div id="add-event-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Добавить семейное событие</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-event-form-modal">
                    <div class="form-group">
                        <label for="event-title">Название события *</label>
                        <input type="text" id="event-title" placeholder="Например: День рождения мамы" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="event-date">Дата события *</label>
                            <input type="date" id="event-date" required>
                        </div>
                        <div class="form-group">
                            <label for="event-type">Тип события</label>
                            <select id="event-type">
                                <option value="birthday">День рождения</option>
                                <option value="wedding">Свадьба</option>
                                <option value="anniversary">Годовщина</option>
                                <option value="holiday">Праздник</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="event-description">Описание</label>
                        <textarea id="event-description" rows="4" placeholder="Расскажите о событии..."></textarea>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary cancel-btn">
                            Отмена
                        </button>
                        <button type="submit" class="btn">
                            Добавить событие
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Уведомления -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button class="notification-close">&times;</button>
        </div>
    </div>

    <!-- Загрузчик -->
    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
        <div class="loader-text" id="loader-text">Загрузка...</div>
    </div>

    <!-- Подключаем библиотеки -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Подключаем наши файлы -->
    <script src="supabase.js"></script>
    <script src="app.js"></script>
    
    <script>
        // Функции для страницы ленты событий
        function updateTimeline() {
            const container = document.getElementById('timeline-container');
            if (!container) return;
            
            // Обновляем фильтр по годам
            updateYearFilter();
            
            // Фильтруем события
            const selectedYear = document.getElementById('filter-year')?.value || '';
            const selectedType = document.getElementById('filter-type')?.value || '';
            
            let filteredEvents = window.events || [];
            
            if (selectedYear) {
                filteredEvents = filteredEvents.filter(event => 
                    new Date(event.date).getFullYear().toString() === selectedYear
                );
            }
            
            if (selectedType) {
                filteredEvents = filteredEvents.filter(event => 
                    event.event_type === selectedType
                );
            }
            
            // Сортируем по дате
            filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <i class="fas fa-calendar" style="font-size: 3rem; margin-bottom: 20px; color: #cbd5e0;"></i>
                        <h3 style="margin-bottom: 10px; color: #4a5568;">Событий пока нет</h3>
                        <p>Добавьте первое событие в вашу семейную историю</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let currentYear = null;
            
            filteredEvents.forEach(event => {
                const date = new Date(event.date);
                const year = date.getFullYear();
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                
                if (year !== currentYear) {
                    html += `<h3 style="margin: 30px 0 15px; color: #2d3748;">${year}</h3>`;
                    currentYear = year;
                }
                
                const icon = getEventIcon(event.event_type);
                
                html += `
                    <div class="timeline-event" style="display: flex; gap: 15px; margin-bottom: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div class="event-icon" style="background: #667eea; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="${icon}"></i>
                        </div>
                        <div class="event-content" style="flex: 1;">
                            <h3 style="margin-bottom: 5px; color: #2d3748;">${event.title}</h3>
                            <div class="event-date" style="color: #718096; font-size: 0.9rem; margin-bottom: 10px;">${formattedDate}</div>
                            ${event.description ? `<p style="color: #4a5568; margin-bottom: 15px;">${event.description}</p>` : ''}
                            <div style="margin-top: 10px;">
                                <button class="btn btn-small edit-event-btn" data-id="${event.id}" style="margin-right: 5px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-small btn-danger delete-event-btn" data-id="${event.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Добавляем обработчики для кнопок редактирования и удаления
            document.querySelectorAll('.edit-event-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const eventId = e.target.closest('button').dataset.id;
                    editEvent(eventId);
                });
            });
            
            document.querySelectorAll('.delete-event-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const eventId = e.target.closest('button').dataset.id;
                    deleteEvent(eventId);
                });
            });
        }
        
        function updateYearFilter() {
            const filter = document.getElementById('filter-year');
            if (!filter) return;
            
            const events = window.events || [];
            const years = [...new Set(events.map(event => 
                new Date(event.date).getFullYear()
            ))].sort((a, b) => b - a);
            
            let html = '<option value="">Все годы</option>';
            years.forEach(year => {
                html += `<option value="${year}">${year}</option>`;
            });
            
            filter.innerHTML = html;
        }
        
        function getEventIcon(eventType) {
            const icons = {
                'birthday': 'fas fa-birthday-cake',
                'wedding': 'fas fa-ring',
                'anniversary': 'fas fa-heart',
                'holiday': 'fas fa-gift',
                'other': 'fas fa-calendar'
            };
            
            return icons[eventType] || 'fas fa-calendar';
        }
        
        async function editEvent(eventId) {
            const event = (window.events || []).find(e => e.id === eventId);
            if (!event) return;
            
            // Заполняем форму
            document.getElementById('event-title').value = event.title;
            document.getElementById('event-date').value = event.date.split('T')[0];
            document.getElementById('event-type').value = event.event_type || 'other';
            document.getElementById('event-description').value = event.description || '';
            
            // Показываем модальное окно
            window.showModal('add-event-modal');
            
            // Меняем заголовок
            const modalTitle = document.querySelector('#add-event-modal h3');
            const submitBtn = document.querySelector('#add-event-modal button[type="submit"]');
            
            if (modalTitle) modalTitle.textContent = 'Редактировать событие';
            if (submitBtn) submitBtn.textContent = 'Сохранить изменения';
            submitBtn.dataset.editingId = eventId;
            
            // Временное изменение обработчика
            const form = document.getElementById('add-event-form-modal');
            const originalSubmit = form.onsubmit;
            
            form.onsubmit = async (e) => {
                e.preventDefault();
                
                const updatedEvent = {
                    title: document.getElementById('event-title').value,
                    date: document.getElementById('event-date').value,
                    event_type: document.getElementById('event-type').value,
                    description: document.getElementById('event-description').value
                };
                
                window.showLoader('Сохранение изменений...');
                
                try {
                    const { error } = await window.supabaseClient
                        .from('events')
                        .update(updatedEvent)
                        .eq('id', eventId);
                    
                    if (error) throw error;
                    
                    // Обновляем в локальном массиве
                    const index = window.events.findIndex(e => e.id === eventId);
                    if (index !== -1) {
                        window.events[index] = { ...window.events[index], ...updatedEvent };
                    }
                    
                    window.showNotification('✅ Событие обновлено!', 'success');
                    window.closeAllModals();
                    updateTimeline();
                    
                } catch (error) {
                    console.error('Ошибка обновления события:', error);
                    window.showNotification('Ошибка обновления события', 'error');
                } finally {
                    window.hideLoader();
                    form.onsubmit = originalSubmit; // Восстанавливаем обработчик
                }
            };
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('Удалить это событие?')) return;
            
            window.showLoader('Удаление события...');
            
            try {
                const { error } = await window.supabaseClient
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                
                if (error) throw error;
                
                // Удаляем из локального массива
                const index = window.events.findIndex(e => e.id === eventId);
                if (index !== -1) {
                    window.events.splice(index, 1);
                }
                
                window.showNotification('✅ Событие удалено!', 'success');
                updateTimeline();
                
            } catch (error) {
                console.error('Ошибка удаления события:', error);
                window.showNotification('Ошибка удаления события', 'error');
            } finally {
                window.hideLoader();
            }
        }
        
        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', async () => {
            // Загружаем данные
            await window.loadUserData();
            
            // Обновляем ленту событий
            updateTimeline();
            
            // Обработчик кнопки добавления события
            document.getElementById('add-event-btn')?.addEventListener('click', () => {
                // Сбрасываем форму
                const form = document.getElementById('add-event-form-modal');
                if (form) form.reset();
                
                // Возвращаем оригинальный заголовок и текст кнопки
                const modalTitle = document.querySelector('#add-event-modal h3');
                const submitBtn = document.querySelector('#add-event-modal button[type="submit"]');
                
                if (modalTitle) modalTitle.textContent = 'Добавить семейное событие';
                if (submitBtn) {
                    submitBtn.textContent = 'Добавить событие';
                    delete submitBtn.dataset.editingId;
                }
                
                // Показываем модальное окно
                window.showModal('add-event-modal');
            });
            
            // Обработчики фильтров
            document.getElementById('filter-year')?.addEventListener('change', updateTimeline);
            document.getElementById('filter-type')?.addEventListener('change', updateTimeline);
        });
        
        // Экспортируем функции
        window.updateTimeline = updateTimeline;
    </script>
</body>
</html>