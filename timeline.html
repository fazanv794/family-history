<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Лента событий - История моей семьи</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header id="app-header">
        <div class="header-container container">
            <a href="app.html" class="logo">
                <i class="fas fa-tree"></i>
                История моей семьи
            </a>
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-links" id="nav-links">
                <li><a href="app.html">Главная</a></li>
                <li><a href="tree.html">Древо</a></li>
                <li><a href="timeline.html" class="active">Лента событий</a></li>
                <li><a href="media.html">Медиатека</a></li>
                <li><a href="profile.html">Мой профиль</a></li>
            </ul>
            <div class="user-menu">
                <span id="username">Гость</span>
                <div class="avatar" id="user-avatar">Г</div>
                <button class="btn btn-small" id="logout-btn">Выйти</button>
            </div>
        </div>
    </header>

    <main id="app-content">
        <section id="timeline-page" class="page">
            <div class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>Лента семейных событий</h2>
                    <button class="btn" id="add-event-btn">
                        <i class="fas fa-plus"></i> Добавить событие
                    </button>
                </div>

                <!-- Фильтры -->
                <div id="timeline-filters" style="margin-bottom: 30px; display: flex; gap: 15px; flex-wrap: wrap;">
                    <select id="filter-year">
                        <option value="">Все годы</option>
                    </select>
                    <select id="filter-type">
                        <option value="">Все типы</option>
                        <option value="birthday">День рождения</option>
                        <option value="wedding">Свадьба</option>
                        <option value="anniversary">Годовщина</option>
                        <option value="holiday">Праздник</option>
                        <option value="other">Другое</option>
                    </select>
                </div>

                <!-- Список событий -->
                <div class="timeline-container" id="timeline-container">
                    <!-- События будут здесь -->
                </div>
            </div>
        </section>
    </main>

    <!-- Модалка добавления/редактирования события -->
    <div id="event-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="modal-title">Добавить событие</h3>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <input type="hidden" id="event-id" name="id">

                    <div class="form-group">
                        <label for="event-title">Название *</label>
                        <input type="text" id="event-title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="event-date">Дата *</label>
                        <input type="date" id="event-date" name="date" required>
                    </div>

                    <div class="form-group">
                        <label for="event-type">Тип события *</label>
                        <select id="event-type" name="type" required>
                            <option value="birthday">День рождения</option>
                            <option value="wedding">Свадьба</option>
                            <option value="anniversary">Годовщина</option>
                            <option value="holiday">Праздник</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="event-description">Описание</label>
                        <textarea id="event-description" name="description" rows="4"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="event-media">Ссылка на фото/видео (опционально)</label>
                        <input type="url" id="event-media" name="media_url" placeholder="https://...">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary cancel-btn">Отмена</button>
                        <button type="submit" class="btn">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Оверлей -->
    <div id="modal-overlay" class="modal-overlay hidden"></div>

    <!-- Уведомления и загрузчик -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-text"></span>
            <button class="notification-close">×</button>
        </div>
    </div>

    <div id="loader" class="loader-overlay hidden">
        <div class="loader"></div>
        <div class="loader-text">Загрузка...</div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="app.js"></script>

    <script>
        // Открытие модалки
        document.getElementById('add-event-btn').addEventListener('click', () => {
            document.getElementById('modal-title').textContent = 'Добавить событие';
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-modal').classList.remove('hidden');
            document.getElementById('modal-overlay').classList.remove('hidden');
        });

        // Закрытие модалки
        document.querySelectorAll('.modal-close, .cancel-btn').forEach(el => {
            el.addEventListener('click', () => {
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('modal-overlay').classList.add('hidden');
            });
        });

        // Отправка формы (без перезагрузки)
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('event-id').value;
            const title = document.getElementById('event-title').value.trim();
            const date = document.getElementById('event-date').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value.trim();
            const media_url = document.getElementById('event-media').value.trim();

            if (!title || !date || !type) {
                window.showNotification('Заполните обязательные поля', 'error');
                return;
            }

            const eventData = {
                title,
                date,
                type,
                description,
                media_url,
                user_id: window.currentUser.id
            };

            try {
                if (id) {
                    // Обновление
                    const { error } = await window.supabaseClient
                        .from('events')
                        .update(eventData)
                        .eq('id', id);

                    if (error) throw error;
                    window.showNotification('Событие обновлено!', 'success');
                } else {
                    // Создание
                    const { error } = await window.supabaseClient
                        .from('events')
                        .insert(eventData);

                    if (error) throw error;
                    window.showNotification('Событие добавлено!', 'success');
                }

                // Закрываем модалку
                document.getElementById('event-modal').classList.add('hidden');
                document.getElementById('modal-overlay').classList.add('hidden');

                // Обновляем ленту без перезагрузки
                loadTimelineEvents();

            } catch (err) {
                console.error(err);
                window.showNotification('Ошибка сохранения: ' + err.message, 'error');
            }
        });

        // Загрузка событий
        async function loadTimelineEvents() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<p style="text-align:center; color:#718096;">Загрузка...</p>';

            try {
                const { data: events, error } = await window.supabaseClient
                    .from('events')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;

                container.innerHTML = '';

                if (!events?.length) {
                    container.innerHTML = '<p style="text-align:center; color:#718096;">Нет событий. Добавьте первое!</p>';
                    return;
                }

                events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-card';
                    eventDiv.style = 'background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);';
                    eventDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="margin: 0; color: #2d3748;">${event.title}</h3>
                            <div>
                                <button class="btn btn-small btn-secondary" onclick="editEvent('${event.id}')">Редактировать</button>
                            </div>
                        </div>
                        <p style="margin: 5px 0; color: #718096;">
                            <i class="fas fa-calendar-alt"></i> ${new Date(event.date).toLocaleDateString('ru-RU')}
                        </p>
                        <p style="margin: 5px 0;">
                            <strong>Тип:</strong> ${event.type === 'birthday' ? 'День рождения' : 
                                event.type === 'wedding' ? 'Свадьба' : 
                                event.type === 'anniversary' ? 'Годовщина' : 
                                event.type === 'holiday' ? 'Праздник' : 'Другое'}
                        </p>
                        ${event.description ? `<p style="margin: 10px 0;">${event.description}</p>` : ''}
                        ${event.media_url ? `<img src="${event.media_url}" alt="Медиа" style="max-width:100%; border-radius:8px; margin-top:10px;">` : ''}
                    `;
                    container.appendChild(eventDiv);
                });

            } catch (err) {
                console.error(err);
                container.innerHTML = '<p style="color:red; text-align:center;">Ошибка загрузки событий</p>';
            }
        }

        // Редактирование события
        window.editEvent = function(id) {
            window.showLoader('Загрузка события...');

            window.supabaseClient
                .from('events')
                .select('*')
                .eq('id', id)
                .single()
                .then(({ data, error }) => {
                    window.hideLoader();
                    if (error || !data) {
                        window.showNotification('Событие не найдено', 'error');
                        return;
                    }

                    document.getElementById('modal-title').textContent = 'Редактировать событие';
                    document.getElementById('event-id').value = data.id;
                    document.getElementById('event-title').value = data.title;
                    document.getElementById('event-date').value = data.date.split('T')[0];
                    document.getElementById('event-type').value = data.type;
                    document.getElementById('event-description').value = data.description || '';
                    document.getElementById('event-media').value = data.media_url || '';

                    // Показываем модалку
                    document.getElementById('event-modal').classList.remove('hidden');
                    document.getElementById('modal-overlay').classList.remove('hidden');
                });
        };

        // Загрузка событий при открытии страницы
        document.addEventListener('DOMContentLoaded', () => {
            loadTimelineEvents();
        });
    </script>
</body>
</html>